<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة واد الرمان - التعليمية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Amiri:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#064e3b',
                        secondary: '#b45309',
                        darkBg: '#020617',
                        cardBg: '#0f172a'
                    },
                    borderRadius: {
                        '3xl': '1.5rem',
                        '4xl': '2.5rem',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Almarai', sans-serif; transition: all 0.4s ease; overflow-x: hidden; }
        .quran-text { font-family: 'Amiri', serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .light .glass-effect { background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(0, 0, 0, 0.05); }
        
        .nav-btn { position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .lg-nav-active { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .mobile-nav-active { color: #10b981 !important; transform: translateY(-5px); }

        @media (min-width: 1024px) { .content-shift { margin-right: 280px; } }
        
        .islamic-pattern { background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l5 25 25 5-25 5-5 25-5-25-25-5 25-5z' fill='%23064e3b' fill-opacity='0.05'/%3E%3C/svg%3E"); }
        .avatar-frame { clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeInUp 0.5s ease-out; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lesson-card:hover .play-overlay { opacity: 1; }
        .book-card { transition: all 0.3s ease; }
        .book-card:hover { transform: translateY(-10px); }

        #search-results-box::-webkit-scrollbar { width: 4px; }
        #search-results-box::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Leaderboard Specific Styles */
        .rank-gold { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%); }
        .rank-silver { background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 100%); }
        .rank-bronze { background: linear-gradient(135deg, #fb923c 0%, #d97706 100%); }
        .podium-item { transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .podium-item:hover { transform: scale(1.05); }

        /* Auth Overly & Animations */
        #auth-overlay { backdrop-filter: blur(25px); background: rgba(2, 6, 23, 0.9); z-index: 1000; transition: all 0.5s ease; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Mobile enhancements: safe area, touch targets, tiny text */
        body { -webkit-tap-highlight-color: transparent; }
        @supports (padding: max(0px)) {
            @media (max-width: 1024px) {
                body { padding-bottom: calc(6rem + env(safe-area-inset-bottom, 0px)); }
            }
        }
        @media (max-width: 640px) {
            button { min-height: 44px; }
            .mb-20 { margin-bottom: 5rem !important; }
        }
        @media (max-width: 360px) {
            .text-\[8px\] { font-size: 10px !important; }
            .text-\[9px\] { font-size: 11px !important; }
        }

        /* Touch targets and readability for very small screens */
        @media (max-width: 480px) {
            .text-\[8px\], .text-\[9px\] { line-height: 1.5 !important; }
            .text-\[8px\] { font-size: 11px !important; }
            .text-\[9px\] { font-size: 12px !important; }
            .text-xs { font-size: 13px !important; }
            .text-sm { font-size: 14px !important; }
            button, a { min-height: 48px; min-width: 48px; }
            .group:hover { transform: none; }
            .space-y-3 > * + * { margin-top: 1rem !important; }
            .space-y-4 > * + * { margin-top: 1.25rem !important; }
            .gap-4 { gap: 1.25rem !important; }
            .gap-6 { gap: 1.75rem !important; }
        }
        @media (max-width: 400px) {
            .text-\[8px\] { font-size: 12px !important; }
            .text-\[9px\] { font-size: 13px !important; }
        }
        
        /* Fix mobile navigation overflow */
        @media (max-width: 480px) {
            .fixed.bottom-0.left-0.w-full { max-width: 100vw; overflow-x: auto; }
            .flex.gap-3 { flex-wrap: nowrap; overflow-x: auto; }
            .flex.items-center.gap-3 { flex-wrap: nowrap; }
        }
        
        /* Fix developer badge positioning */
        @media (max-width: 480px) {
            .fixed.top-16.left-4 { 
                position: fixed !important;
                top: 4rem !important; 
                left: 1rem !important;
                max-width: calc(100vw - 2rem);
                z-index: 102 !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-slate-100 islamic-pattern pb-20 lg:pb-0">

    <!-- نظام التسجيل والدخول (Auth Overlay) -->
    <div id="auth-overlay" class="fixed inset-0 flex items-center justify-center p-4">
        <div id="auth-card" class="w-full max-w-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-[2.5rem] p-8 md:p-10 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-l from-emerald-600 via-amber-500 to-emerald-600"></div>
            
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-emerald-500/10 rounded-3xl flex items-center justify-center mx-auto mb-4 text-emerald-600">
                    <i data-lucide="shield-check" size="40"></i>
                </div>
                <h2 id="auth-title" class="text-2xl font-black quran-text text-emerald-950 dark:text-white">تسجيل الدخول</h2>
                <p id="auth-subtitle" class="text-slate-500 text-xs mt-2 font-bold">بوابة العلم والمعرفة ترحب بك</p>
            </div>

            <!-- Error Message -->
            <div id="auth-error" class="hidden flex items-center gap-3 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-600 dark:text-red-400 text-xs font-bold mb-6">
                <i data-lucide="alert-circle" size="18"></i>
                <span id="error-text">حدث خطأ ما</span>
            </div>

            <!-- Form -->
            <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-4">
                <div id="reg-fields" class="hidden space-y-4">
                    <div class="relative">
                        <i data-lucide="user" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400" size="18"></i>
                        <input type="text" id="auth-name" placeholder="الاسم الكامل" class="w-full py-4 pr-12 pl-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl outline-none focus:border-emerald-500 dark:text-white font-bold transition-all">
                    </div>
                </div>
                <div class="relative">
                    <i data-lucide="mail" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400" size="18"></i>
                    <input type="email" id="auth-email" placeholder="البريد الإلكتروني" required class="w-full py-4 pr-12 pl-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl outline-none focus:border-emerald-500 dark:text-white font-bold transition-all">
                </div>
                <div class="relative">
                    <i data-lucide="lock" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400" size="18"></i>
                    <input type="password" id="auth-pass" placeholder="كلمة المرور" required class="w-full py-4 pr-12 pl-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl outline-none focus:border-emerald-500 dark:text-white font-bold transition-all">
                </div>
                <button type="submit" id="auth-submit" class="w-full py-4 bg-emerald-700 hover:bg-emerald-600 text-white rounded-2xl font-black text-lg transition-all shadow-xl shadow-emerald-900/20">دخول</button>
            </form>

            <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-800 text-center">
                <p class="text-slate-500 text-xs font-bold">
                    <span id="auth-switch-text">ليس لديك حساب؟</span>
                    <button onclick="toggleAuthMode()" id="auth-switch-btn" class="text-emerald-600 font-black hover:underline ml-1">إنشاء حساب جديد</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Sidebar (Desktop) -->
    <aside class="fixed top-0 right-0 h-full w-[280px] glass-effect z-[70] hidden lg:flex flex-col p-8 border-l border-slate-200 dark:border-slate-800">
        <div class="mb-12 flex items-center gap-4">
            <div class="p-3 bg-amber-500 rounded-2xl shadow-lg shadow-amber-500/20">
                <i data-lucide="book-marked" class="text-white" size="28"></i>
            </div>
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight text-emerald-900 dark:text-emerald-400">واد الرمان</h1>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">البوابة التعليمية</p>
            </div>
        </div>

        <nav class="space-y-3 flex-1">
            <button onclick="switchTab('home')" id="d-nav-home" class="nav-btn lg-nav-active group w-full flex items-center gap-4 px-5 py-4 rounded-2xl font-bold transition-all hover:bg-emerald-500/10">
                <i data-lucide="layout-dashboard" size="20"></i> الرئيسية
            </button>
            <button onclick="switchTab('lessons')" id="d-nav-lessons" class="nav-btn group w-full flex items-center gap-4 px-5 py-4 rounded-2xl font-bold transition-all hover:bg-emerald-500/10">
                <i data-lucide="play-circle" size="20"></i> الدروس العلمية
            </button>
            <button onclick="switchTab('quiz')" id="d-nav-quiz" class="nav-btn group w-full flex items-center gap-4 px-5 py-4 rounded-2xl font-bold transition-all hover:bg-emerald-500/10">
                <i data-lucide="swords" size="20"></i> تحدي الوقت
            </button>
            <button onclick="switchTab('library')" id="d-nav-library" class="nav-btn group w-full flex items-center gap-4 px-5 py-4 rounded-2xl font-bold transition-all hover:bg-emerald-500/10">
                <i data-lucide="library" size="20"></i> المكتبة
            </button>
            <button onclick="switchTab('leaderboard')" id="d-nav-leaderboard" class="nav-btn group w-full flex items-center gap-4 px-5 py-4 rounded-2xl font-bold transition-all hover:bg-emerald-500/10">
                <i data-lucide="trophy" size="20"></i> لوحة التميز
            </button>
        </nav>

        <button onclick="handleLogout()" class="mt-4 flex items-center gap-4 px-5 py-4 rounded-2xl font-bold text-red-500 hover:bg-red-500/10 transition-all border border-transparent hover:border-red-500/20">
            <i data-lucide="log-out" size="20"></i> تسجيل الخروج
        </button>

        <div class="p-6 bg-emerald-950/5 dark:bg-emerald-500/5 rounded-3xl border border-emerald-500/10 mt-auto">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-emerald-600 flex items-center justify-center text-white">
                    <i data-lucide="terminal" size="18"></i>
                </div>
                <div>
                    <p class="text-[9px] font-bold text-emerald-600 uppercase">المطور</p>
                    <p class="text-xs font-extrabold">شاوشي ابراهيم</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Developer Credit (Mobile Top Left) -->
    <div class="fixed top-16 left-4 z-[101] lg:hidden flex items-center gap-2 bg-emerald-600 text-white px-3 py-2 rounded-full shadow-lg">
        <i data-lucide="terminal" size="16"></i>
        <span class="text-[10px] font-bold">المطور: شاوشي ابراهيم</span>
    </div>

    <!-- Bottom Nav (Mobile) -->
    <nav class="fixed bottom-0 left-0 w-full glass-effect z-[100] lg:hidden px-4 py-4 flex justify-between items-center border-t border-slate-200 dark:border-slate-800 shadow-[0_-10px_25px_-5px_rgba(0,0,0,0.1)]">
        <div class="flex items-center gap-3">
            <button onclick="switchTab('home')" id="m-nav-home" class="m-nav-btn flex flex-col items-center gap-1 text-emerald-500 mobile-nav-active transition-all transform hover:scale-110 active:scale-95"><i data-lucide="home" size="24"></i><span class="text-[9px] font-bold">الرئيسية</span></button>
            <button onclick="switchTab('lessons')" id="m-nav-lessons" class="m-nav-btn flex flex-col items-center gap-1 text-slate-400 transition-all transform hover:scale-110 active:scale-95"><i data-lucide="play-circle" size="24"></i><span class="text-[9px] font-bold">الدروس</span></button>
            <button onclick="switchTab('quiz')" id="m-nav-quiz" class="m-nav-btn flex flex-col items-center gap-1 text-slate-400 transition-all transform hover:scale-110 active:scale-95"><i data-lucide="zap" size="24"></i><span class="text-[9px] font-bold">تحدي</span></button>
            <button onclick="switchTab('library')" id="m-nav-library" class="m-nav-btn flex flex-col items-center gap-1 text-slate-400 transition-all transform hover:scale-110 active:scale-95"><i data-lucide="library" size="24"></i><span class="text-[9px] font-bold">المكتبة</span></button>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="switchTab('leaderboard')" id="m-nav-leaderboard" class="m-nav-btn flex flex-col items-center gap-1 text-slate-400 transition-all transform hover:scale-110 active:scale-95"><i data-lucide="trophy" size="24"></i><span class="text-[9px] font-bold">التميز</span></button>
            <button onclick="handleLogout()" class="m-nav-btn flex flex-col items-center gap-1 text-red-500 hover:text-red-600 transition-all transform hover:scale-110 active:scale-95"><i data-lucide="log-out" size="24"></i><span class="text-[9px] font-bold">خروج</span></button>
        </div>
    </nav>

    <main class="content-shift p-4 md:p-8 lg:p-12 mb-20 lg:mb-0 transition-all">
        <div class="max-w-6xl mx-auto">
            
            <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8 md:mb-12 relative z-[90]">
                <div class="flex items-center gap-4 md:gap-5 w-full md:w-auto">
                    <div class="w-14 h-14 md:w-16 md:h-16 bg-white dark:bg-slate-800 avatar-frame shadow-xl ring-2 ring-amber-500/30 overflow-hidden shrink-0">
                        <img id="img-avatar-top" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Ibrahim" alt="Avatar" class="w-full h-full object-cover">
                    </div>
                    <div class="overflow-hidden">
                        <h2 id="page-title" class="text-2xl md:text-3xl font-black text-emerald-950 dark:text-white quran-text leading-tight truncate">الرئيسية</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="flex h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span>
                            <p id="header-welcome-text" class="text-[10px] md:text-sm font-bold text-slate-500 italic truncate italic">أهلاً بك، <span id="display-user-name">ضيف المنصة</span></p>
                        </div>
                    </div>
                </div>

                <div class="relative w-full md:w-96 group">
                    <div class="relative flex items-center">
                        <input type="text" id="smart-search-input" 
                               placeholder="ابحث عن كتاب، درس، أو قسم..." 
                               class="w-full py-3.5 md:py-4 pr-12 pl-6 bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none font-bold text-sm shadow-sm"
                               oninput="handleSmartSearch(this.value)">
                        <div class="absolute right-4 text-slate-400 group-focus-within:text-emerald-500 transition-colors">
                            <i data-lucide="search" size="18"></i>
                        </div>
                    </div>
                    <div id="search-results-box" class="hidden absolute top-full left-0 w-full mt-3 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 max-h-[60vh] md:max-h-[400px] overflow-y-auto z-[110]"></div>
                </div>

                <div class="hidden md:flex items-center gap-4">
                    <button onclick="toggleTheme()" class="p-4 glass-effect rounded-2xl text-amber-500 hover:scale-110 active:scale-95 transition-all shadow-lg border border-slate-200 dark:border-slate-800">
                        <i id="theme-icon" data-lucide="moon" size="22"></i>
                    </button>
                </div>
            </header>

            <div id="main-content">
                
                <!-- Home Tab -->
                <section id="tab-home" class="tab-content active">
                    <div class="relative rounded-[2rem] md:rounded-[3rem] overflow-hidden bg-emerald-950 p-8 md:p-12 lg:p-24 text-white shadow-2xl">
                        <div class="relative z-10 max-w-2xl">
                            <h3 class="text-3xl md:text-5xl lg:text-7xl font-black mb-6 md:mb-8 leading-[1.2] quran-text">نور العلم <br><span class="text-amber-500">يهدي السبيل</span></h3>
                            <p class="text-sm md:text-lg text-emerald-100/70 mb-8 md:mb-12 leading-relaxed">مرحبًا بك في بوابة واد الرمان التعليمية الشاملة.</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button onclick="switchTab('lessons')" class="w-full sm:w-auto px-8 py-4 bg-emerald-600 text-white font-black rounded-2xl hover:bg-emerald-500 transition-all shadow-xl">تصفح الدروس</button>
                                <button onclick="switchTab('quiz')" class="w-full sm:w-auto px-8 py-4 bg-amber-500 text-emerald-950 font-black rounded-2xl hover:bg-amber-400 transition-all shadow-xl">تحدي الوقت</button>
                            </div>
                        </div>
                        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none islamic-pattern"></div>
                    </div>
                </section>

                <!-- Lessons Tab -->
                <section id="tab-lessons" class="tab-content">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <h3 class="text-2xl md:text-3xl font-black text-emerald-950 dark:text-emerald-400 quran-text">الأكاديمية العلمية</h3>
                            <p class="text-xs md:text-sm text-slate-500 font-bold">دروس منهجية مرئية ومسموعة.</p>
                        </div>
                        <div class="w-full md:w-auto flex overflow-x-auto gap-2 pb-2 hide-scrollbar">
                            <button onclick="filterLessons('الكل', this)" class="les-filter-btn shrink-0 px-5 py-2.5 bg-emerald-600 text-white rounded-xl font-black text-xs transition-all shadow-md">الكل</button>
                            <button onclick="filterLessons('عقيدة', this)" class="les-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">عقيدة</button>
                            <button onclick="filterLessons('فقه', this)" class="les-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">فقه</button>
                            <button onclick="filterLessons('سيرة', this)" class="les-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">سيرة</button>
                            <button onclick="filterLessons('لغة', this)" class="les-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">لغة</button>
                        </div>
                    </div>
                    <div id="lessons-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"></div>
                </section>

                <!-- Quiz Tab -->
                <section id="tab-quiz" class="tab-content">
                    <div id="quiz-intro" class="max-w-3xl mx-auto text-center space-y-6 md:space-y-8 p-8 md:p-12 glass-effect rounded-[2.5rem] md:rounded-[3.5rem] border-b-8 border-amber-500 shadow-2xl">
                        <div class="w-16 h-16 md:w-24 md:h-24 bg-amber-500/20 text-amber-500 rounded-2xl md:rounded-3xl flex items-center justify-center mx-auto animate-bounce"><i data-lucide="timer" size="32"></i></div>
                        <h3 class="text-2xl md:text-4xl font-black quran-text">سباق العلم والمعرفة</h3>
                        <p class="text-sm md:text-lg text-slate-500 font-bold leading-relaxed">تحدي إيماني معرفي سريع. أجب على الأسئلة لجمع النقاط!</p>
                        <button onclick="startQuiz()" class="w-full py-4 md:py-6 bg-emerald-900 text-white rounded-2xl md:rounded-3xl font-black text-xl md:text-2xl hover:bg-emerald-800 transition-all">باسم الله، نبدأ!</button>
                    </div>
                    <div id="quiz-container" class="hidden max-w-4xl mx-auto space-y-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4 glass-effect p-4 md:p-6 rounded-2xl md:rounded-3xl">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 md:w-12 md:h-12 bg-emerald-500 text-white rounded-xl flex items-center justify-center font-black" id="current-q-num">1</div>
                                <div><p class="text-[9px] font-black text-slate-400 uppercase">السؤال</p><p class="text-xs md:text-sm font-bold" id="q-category">ثقافة عامة</p></div>
                            </div>
                            <div id="timer-display" class="text-xl md:text-2xl font-black text-amber-500">60</div>
                            <div id="score-display" class="text-xl md:text-2xl font-black text-emerald-500">0</div>
                        </div>
                        <div class="glass-effect p-6 md:p-16 rounded-[2rem] md:rounded-[3rem] text-center">
                            <div id="question-text" class="text-xl md:text-3xl font-black mb-8 md:mb-12 quran-text"></div>
                            <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4"></div>
                        </div>
                    </div>
                </section>

                <!-- Library Tab -->
                <section id="tab-library" class="tab-content">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                        <div>
                            <h3 class="text-2xl md:text-3xl font-black text-emerald-950 dark:text-emerald-400 quran-text">المكتبة الرقمية</h3>
                            <p class="text-xs md:text-sm text-slate-500 font-bold">استكشف أمّهات الكتب الشرعية المحدثة.</p>
                        </div>
                        <div class="w-full md:w-auto flex overflow-x-auto gap-2 pb-2 hide-scrollbar">
                            <button onclick="filterBooks('الكل', this)" class="lib-filter-btn shrink-0 px-5 py-2.5 bg-emerald-600 text-white rounded-xl font-black text-xs transition-all shadow-md">الكل</button>
                            <button onclick="filterBooks('عقيدة', this)" class="lib-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">عقيدة</button>
                            <button onclick="filterBooks('فقه', this)" class="lib-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">فقه</button>
                            <button onclick="filterBooks('سيرة', this)" class="lib-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">سيرة</button>
                            <button onclick="filterBooks('لغة', this)" class="lib-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all">لغة</button>
                        </div>
                    </div>
                    <div id="books-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6"></div>
                </section>

                <!-- Leaderboard Tab -->
                <section id="tab-leaderboard" class="tab-content">
                    <div class="max-w-4xl mx-auto space-y-12">
                        <div class="flex items-end justify-center gap-4 md:gap-8 pt-10 px-4">
                            <div class="podium-item flex-1 flex flex-col items-center max-w-[140px] order-1">
                                <div class="relative mb-4">
                                    <div class="w-16 h-16 md:w-24 md:h-24 rounded-full bg-slate-200 dark:bg-slate-800 border-4 border-slate-400 overflow-hidden p-1 shadow-lg">
                                        <img id="avatar-rank-2" src="" class="w-full h-full rounded-full object-cover">
                                    </div>
                                    <div class="absolute -bottom-2 right-1/2 translate-x-1/2 rank-silver w-8 h-8 rounded-full flex items-center justify-center font-black text-white text-xs border-2 border-white dark:border-slate-900 shadow-md">2</div>
                                </div>
                                <p id="name-rank-2" class="font-black text-xs md:text-sm text-center truncate w-full">---</p>
                                <p id="points-rank-2" class="text-emerald-500 font-bold text-[10px] md:text-xs">0 نقطة</p>
                                <p id="label-rank-2" class="text-[10px] md:text-xs font-bold text-slate-400">---</p>
                                <div class="w-full h-24 md:h-32 bg-slate-200/50 dark:bg-slate-800/50 rounded-t-3xl mt-4 border-x border-t border-slate-300 dark:border-slate-700"></div>
                            </div>
                            <div class="podium-item flex-1 flex flex-col items-center max-w-[160px] order-2 -translate-y-4">
                                <div class="relative mb-4">
                                    <div class="w-20 h-20 md:w-32 md:h-32 rounded-full bg-white dark:bg-slate-800 border-4 border-amber-400 overflow-hidden p-1 shadow-2xl ring-4 ring-amber-400/20">
                                        <img id="avatar-rank-1" src="" class="w-full h-full rounded-full object-cover">
                                    </div>
                                    <div class="absolute -bottom-2 right-1/2 translate-x-1/2 rank-gold w-10 h-10 rounded-full flex items-center justify-center font-black text-white text-base border-2 border-white dark:border-slate-900 shadow-xl animate-pulse">1</div>
                                </div>
                                <p id="name-rank-1" class="font-black text-sm md:text-lg text-center truncate w-full">---</p>
                                <p id="points-rank-1" class="text-amber-500 font-bold text-xs md:text-sm">0 نقطة</p>
                                <p id="label-rank-1" class="text-[10px] md:text-xs font-bold text-slate-400">---</p>
                                <div class="w-full h-32 md:h-44 bg-amber-500/10 rounded-t-3xl mt-4 border-x border-t border-amber-500/30 relative">
                                    <div class="absolute inset-0 islamic-pattern opacity-5"></div>
                                </div>
                            </div>
                            <div class="podium-item flex-1 flex flex-col items-center max-w-[140px] order-3">
                                <div class="relative mb-4">
                                    <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-slate-200 dark:bg-slate-800 border-4 border-amber-700 overflow-hidden p-1 shadow-lg">
                                        <img id="avatar-rank-3" src="" class="w-full h-full rounded-full object-cover">
                                    </div>
                                    <div class="absolute -bottom-2 right-1/2 translate-x-1/2 rank-bronze w-7 h-7 rounded-full flex items-center justify-center font-black text-white text-[10px] border-2 border-white dark:border-slate-900 shadow-md">3</div>
                                </div>
                                <p id="name-rank-3" class="font-black text-xs md:text-sm text-center truncate w-full">---</p>
                                <p id="points-rank-3" class="text-emerald-500 font-bold text-[10px] md:text-xs">0 نقطة</p>
                                <p id="label-rank-3" class="text-[10px] md:text-xs font-bold text-slate-400">---</p>
                                <div class="w-full h-20 md:h-24 bg-slate-200/50 dark:bg-slate-800/50 rounded-t-3xl mt-4 border-x border-t border-slate-300 dark:border-slate-700"></div>
                            </div>
                        </div>
                        <div class="glass-effect rounded-[2.5rem] overflow-hidden shadow-2xl border border-slate-200 dark:border-slate-800">
                            <div class="p-6 bg-emerald-500/5 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                                <h4 class="font-black text-emerald-950 dark:text-emerald-400">قائمة فرسان العلم</h4>
                                <span class="px-4 py-1.5 bg-emerald-500/10 rounded-full text-[10px] font-black text-emerald-600 uppercase tracking-widest">تحديث مباشر</span>
                            </div>
                            <div id="leaderboard-list" class="divide-y divide-slate-200 dark:divide-slate-800"></div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // --- Database ---
        const libraryDB = [
            { title: "الأصول الثلاثة", author: "ابن عبد الوهاب", category: "عقيدة", color: "bg-emerald-900", icon: "scroll" },
            { title: "كتاب التوحيد", author: "ابن عبد الوهاب", category: "عقيدة", color: "bg-emerald-800", icon: "shield" },
            { title: "العقيدة الطحاوية", author: "الإمام الطحاوي", category: "عقيدة", color: "bg-emerald-700", icon: "bookmark" },
            { title: "متن أبي شجاع", author: "الأصفهاني", category: "فقه", color: "bg-blue-900", icon: "scale" },
            { title: "منهاج الطالبين", author: "الإمام النووي", category: "فقه", color: "bg-blue-800", icon: "landmark" },
            { title: "قطر الندى", author: "ابن هشام", category: "لغة", color: "bg-amber-900", icon: "pen-tool" },
            { title: "الرحيق المختوم", author: "المباركفوري", category: "سيرة", color: "bg-rose-900", icon: "sun" },
            { title: "زاد المعاد", author: "ابن القيم", category: "سيرة", color: "bg-rose-800", icon: "heart" },
            { title: "سيرة ابن هشام", author: "ابن هشام", category: "سيرة", color: "bg-rose-700", icon: "book-open" },
            { title: "الآجرومية", author: "ابن آجروم", category: "لغة", color: "bg-amber-800", icon: "languages" },
            { title: "ألفية ابن مالك", author: "ابن مالك", category: "لغة", color: "bg-amber-700", icon: "edit-3" }
        ];

        const lessonsDB = [
            { title: "شرح الأصول الثلاثة - الدرس الأول", teacher: "الشيخ عبد الرزاق البدر", category: "عقيدة", duration: "45:00", icon: "shield-check" },
            { title: "تفسير سورة الفاتحة", teacher: "الشيخ صالح الفوزان", category: "فقه", duration: "30:00", icon: "book-open" },
            { title: "الشمائل المحمدية", teacher: "الشيخ محمد بن هادي", category: "سيرة", duration: "50:00", icon: "sun" },
            { title: "أساسيات النحو العربي", teacher: "أستاذ اللغة العربية", category: "لغة", duration: "40:00", icon: "languages" },
            { title: "منهج السالكين - العبادات", teacher: "الشيخ السعدي رحمه الله", category: "فقه", duration: "35:00", icon: "landmark" },
            { title: "فقه الصلاة - أحكام السجود", teacher: "الشيخ ابن عثيمين", category: "فقه", duration: "25:00", icon: "user-check" },
            { title: "المقدمة الآجرومية - المبتدأ", teacher: "الشيخ محمد محيي الدين", category: "لغة", duration: "32:00", icon: "pen-tool" }
        ];

        const quizDB = [
            { q: "كم عدد أركان الإسلام؟", a: ["أربعة", "خمسة", "ستة", "سبعة"], c: 1 },
            { q: "ما أول ركن من أركان الإسلام؟", a: ["الشهادتان", "الصلاة", "الزكاة", "الحج"], c: 0 },
            { q: "كم عدد أركان الإيمان؟", a: ["خمسة", "ستة", "سبعة", "ثمانية"], c: 1 },
            { q: "ما أول سورة في المصحف؟", a: ["الفاتحة", "البقرة", "الإخلاص", "العلق"], c: 0 },
            { q: "كم عدد سور القرآن؟", a: ["112", "114", "116", "120"], c: 1 },
            { q: "من هو خاتم الأنبياء؟", a: ["عيسى", "موسى", "محمد", "إبراهيم"], c: 2 },
            { q: "في أي غار نزل الوحي أول مرة؟", a: ["غار حراء", "غار ثور", "غار يعقوب", "لا شيء مما سبق"], c: 0 },
            { q: "ما هي قبلة المسلمين؟", a: ["الكعبة", "بيت المقدس", "طور سيناء", "المسجد الأقصى"], c: 0 },
            { q: "كم عدد الصلوات المفروضة؟", a: ["ثلاث", "أربع", "خمس", "ست"], c: 2 },
            { q: "صوم رمضان حكمه؟", a: ["فرض", "سنة", "مباح", "مكروه"], c: 0 },
            { q: "متى يبدأ وقت صلاة المغرب؟", a: ["عند غروب الشمس", "عند زوال الشمس", "عند الفجر", "عند منتصف الليل"], c: 0 },
            { q: "من هو أول الخلفاء الراشدين؟", a: ["أبو بكر الصديق", "عمر بن الخطاب", "عثمان بن عفان", "علي بن أبي طالب"], c: 0 },
            { q: "من هو ثاني الخلفاء الراشدين؟", a: ["عثمان بن عفان", "علي بن أبي طالب", "عمر بن الخطاب", "معاوية بن أبي سفيان"], c: 2 },
            { q: "ما السورة التي تسمى قلب القرآن؟", a: ["يس", "الرحمن", "الإخلاص", "الفلق"], c: 0 },
            { q: "أي سورة تعدل ثلث القرآن؟", a: ["الإخلاص", "الفاتحة", "الكافرون", "الناس"], c: 0 },
            { q: "كم مرة ذُكر محمداسم  في القرآن؟", a: ["أربع مرات", "خمس مرات", "ست مرات", "سبع مرات"], c: 0 },
            { q: "ما العبارة التي تُقال عند بدء القراءة؟", a: ["بسم الله الرحمن الرحيم", "الحمد لله", "سبحان الله", "لا إله إلا الله"], c: 0 },
            { q: "ليلة القدر تكون في شهر؟", a: ["شعبان", "رمضان", "رجب", "محرم"], c: 1 },
            { q: "أول مسجد بني في الإسلام؟", a: ["المسجد الحرام", "مسجد قباء", "المسجد النبوي", "المسجد الأقصى"], c: 1 },
            { q: "كم عدد أشواط الطواف؟", a: ["خمسة", "ستة", "سبعة", "ثمانية"], c: 2 },
            { q: "إتمام السعي يكون بين؟", a: ["الصفا والمروة", "منى وعرفة", "الصفا ومنى", "عرفة والمزدلفة"], c: 0 },
            { q: "الزكاة ركن من؟", a: ["أركان الإسلام", "أركان الإيمان", "الإحسان", "السنن"], c: 0 },
            { q: "أي السور تبدأ بسبحان؟", a: ["الإسراء", "الرحمن", "الحديد", "الفجر"], c: 0 },
            { q: "من هو ذو النون؟", a: ["يونس", "يوسف", "أيوب", "إلياس"], c: 0 },
            { q: "اسم والد إبراهيم عليه السلام؟", a: ["عمران", "آزر", "عمر", "نوح"], c: 1 },
            { q: "أيُّ المخلوقات تكلم في القرآن؟", a: ["النملة", "الهدهد", "البقرة", "كلب أصحاب الكهف"], c: 0 },
            { q: "ما الصلاة التي لا ركوع فيها ولا سجود؟", a: ["صلاة الجنازة", "الوتر", "العيد", "الاستخارة"], c: 0 },
            { q: "أطول سورة في القرآن؟", a: ["البقرة", "آل عمران", "النساء", "الأعراف"], c: 0 },
            { q: "أقصر سورة في القرآن؟", a: ["الإخلاص", "الكوثر", "الفلق", "الناس"], c: 1 },
            { q: "كم عدد أركان الحج؟", a: ["اثنان", "ثلاثة", "أربعة", "خمسة"], c: 2 }
        ];

        let leaderboardData = [
            { name: "عمر الفاروق", score: 1580, seed: "Omar" },
            { name: "إبراهيم شاوشي", score: 1250, seed: "Ibrahim" },
            { name: "زيد بن ثابت", score: 980, seed: "Zaid" },
            { name: "أحمد بن حنبل", score: 850, seed: "Ahmed" },
            { name: "علي محمد", score: 720, seed: "Ali" },
            { name: "خديجة بنت خويلد", score: 680, seed: "Khadija" }
        ];

        // --- Auth State ---
        let isLoginMode = true;
        let currentUser = null;

        // --- Auth Functions ---
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-title');
            const submit = document.getElementById('auth-submit');
            const switchBtn = document.getElementById('auth-switch-btn');
            const switchText = document.getElementById('auth-switch-text');
            const regFields = document.getElementById('reg-fields');
            
            if(isLoginMode) {
                title.innerText = "تسجيل الدخول";
                submit.innerText = "دخول";
                switchText.innerText = "ليس لديك حساب؟";
                switchBtn.innerText = "إنشاء حساب جديد";
                regFields.classList.add('hidden');
            } else {
                title.innerText = "إنشاء حساب";
                submit.innerText = "اشتراك";
                switchText.innerText = "لديك حساب بالفعل؟";
                switchBtn.innerText = "تسجيل الدخول";
                regFields.classList.remove('hidden');
            }
            document.getElementById('auth-error').classList.add('hidden');
        }

        function showAuthError(msg) {
            const errorBox = document.getElementById('auth-error');
            const errorText = document.getElementById('error-text');
            const card = document.getElementById('auth-card');
            
            errorText.innerText = msg;
            errorBox.classList.remove('hidden');
            card.classList.add('shake');
            setTimeout(() => card.classList.remove('shake'), 400);
        }

        function getStoredUsers() {
            try {
                const raw = localStorage.getItem('wr_users');
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        }

        function saveStoredUsers(users) {
            try { localStorage.setItem('wr_users', JSON.stringify(users)); } catch (e) {}
        }

        function findStoredUserByEmail(email) {
            const users = getStoredUsers();
            return users.find(u => u.email === email);
        }

        function shouldRemember() {
            const cb = document.getElementById('remember-me');
            return !cb || cb.checked;
        }

        function ensureRememberMeUI() {
            const form = document.getElementById('auth-form');
            const submitBtn = document.getElementById('auth-submit');
            if (!form || !submitBtn) return;
            if (document.getElementById('remember-me')) return;
            const wrap = document.createElement('div');
            wrap.className = 'flex items-center justify-between text-xs font-bold text-slate-500';
            wrap.innerHTML = `
                <label class="inline-flex items-center gap-2 cursor-pointer">
                    <input id="remember-me" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" checked>
                    <span>تذكرني</span>
                </label>
            `;
            form.insertBefore(wrap, submitBtn);
        }

        function ensurePasswordToggleUI() {
            const passInput = document.getElementById('auth-pass');
            if (!passInput) return;
            const container = passInput.parentElement;
            if (!container) return;
            if (container.querySelector('#toggle-pass-btn')) return;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.id = 'toggle-pass-btn';
            btn.className = 'absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-emerald-600 transition-colors';
            btn.setAttribute('aria-label', 'إظهار/إخفاء كلمة المرور');
            btn.innerHTML = '<i data-lucide="eye" size="18"></i>';
            btn.addEventListener('click', () => {
                const hidden = passInput.type === 'password';
                passInput.type = hidden ? 'text' : 'password';
                btn.innerHTML = `<i data-lucide="${hidden ? 'eye-off' : 'eye'}" size="18"></i>`;
                lucide.createIcons();
            });
            container.appendChild(btn);
            lucide.createIcons();
        }

        function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const name = document.getElementById('auth-name').value;

            if (isLoginMode) {
                // Mock Login Logic
                if (email === "test@test.com" && pass === "123456") {
                    loginUser({ name: "شاوشي ابراهيم", email: email, seed: "Ibrahim" });
                } else {
                    const users = getStoredUsers();
                    const user = users.find(u => u.email === email && u.pass === pass);
                    if (user) {
                        loginUser(user);
                    } else {
                        showAuthError("البريد الإلكتروني أو كلمة المرور غير صحيحة.");
                    }
                }
            } else {
                // Mock Register Logic
                if (name.length < 3) {
                    showAuthError("الاسم الكامل قصير جداً.");
                } else if (pass.length < 6) {
                    showAuthError("كلمة المرور يجب أن تكون 6 أحرف على الأقل.");
                } else {
                    if (findStoredUserByEmail(email)) {
                        showAuthError("هذا البريد مسجل مسبقًا.");
                        return;
                    }
                    const newUser = { name: name, email: email, pass: pass, seed: name };
                    const users = getStoredUsers();
                    users.push(newUser);
                    saveStoredUsers(users);
                    loginUser(newUser);
                }
            }
        }

        function loginUser(user) {
            currentUser = user;
            try { if (shouldRemember()) localStorage.setItem('wr_session', JSON.stringify({ name: user.name, email: user.email, seed: user.seed })); } catch (e) {}
            document.getElementById('auth-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('auth-overlay').style.display = 'none';
            }, 500);

            // Update UI with User Info
            document.getElementById('display-user-name').innerText = user.name;
            document.getElementById('img-avatar-top').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.seed}`;
            
            // Initial Renders
            renderLibrary();
            renderLessons();
            renderLeaderboard();
        }

        function handleLogout() {
            currentUser = null;
            try { localStorage.removeItem('wr_session'); } catch (e) {}
            document.getElementById('auth-overlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('auth-overlay').style.opacity = '1';
            }, 50);
            switchTab('home');
        }

        // --- Core Renders ---
        function renderLibrary() {
            const grid = document.getElementById('books-grid');
            if(!grid) return;
            grid.innerHTML = libraryDB.map(book => `
                <div class="book-card group bg-white dark:bg-slate-800 rounded-2xl md:rounded-3xl overflow-hidden shadow-lg border border-slate-100 dark:border-slate-800 cursor-pointer" data-category="${book.category}">
                    <div class="aspect-[3/4] ${book.color} flex flex-col items-center justify-center p-4 md:p-6 text-center relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10 islamic-pattern"></div>
                        <i data-lucide="${book.icon}" class="text-white/20 mb-2 md:mb-4" size="48"></i>
                        <h4 class="text-white font-black text-sm md:text-lg quran-text leading-tight z-10">${book.title}</h4>
                        <p class="text-white/60 text-[8px] md:text-[10px] font-bold mt-1 md:mt-2 uppercase truncate w-full px-2">${book.author}</p>
                    </div>
                    <div class="p-3 md:p-4 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                        <span class="text-[8px] md:text-[10px] font-black text-emerald-600 px-2 py-0.5 md:py-1 bg-emerald-500/10 rounded-lg">${book.category}</span>
                        <i data-lucide="external-link" size="12" class="text-slate-400"></i>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderLessons() {
            const grid = document.getElementById('lessons-grid');
            if(!grid) return;
            grid.innerHTML = lessonsDB.map(lesson => `
                <div class="lesson-card group relative bg-white dark:bg-slate-800 rounded-[2rem] md:rounded-[2.5rem] overflow-hidden shadow-xl border border-slate-100 dark:border-slate-800 transition-all" data-category="${lesson.category}">
                    <div class="aspect-video bg-emerald-950 relative flex items-center justify-center overflow-hidden">
                        <div class="play-overlay absolute inset-0 bg-black/40 opacity-0 transition-opacity flex items-center justify-center z-10"><i data-lucide="play" class="text-white" size="40"></i></div>
                        <i data-lucide="${lesson.icon}" size="40" class="text-emerald-500/20"></i>
                        <div class="absolute bottom-3 right-3 px-2 py-1 bg-black/60 text-[10px] text-white rounded-md font-bold">${lesson.duration}</div>
                    </div>
                    <div class="p-6">
                        <span class="text-emerald-500 font-black text-[9px] uppercase mb-2 block tracking-widest">${lesson.category}</span>
                        <h4 class="text-base md:text-lg font-black mb-3 dark:text-white quran-text leading-tight">${lesson.title}</h4>
                        <p class="text-[10px] font-bold text-slate-400 mb-4">${lesson.teacher}</p>
                        <button class="w-full py-2.5 bg-emerald-500/10 text-emerald-600 rounded-xl text-[10px] font-black hover:bg-emerald-500 hover:text-white transition-all">مشاهدة الدرس</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function getTier(score) {
            if (score >= 1700) return { label: 'طالب متميز', color: 'text-amber-500' };
            if (score < 700) return { label: 'طالب متوسط', color: 'text-slate-400' };
            return { label: 'طالب مجتهد', color: 'text-emerald-500' };
        }

        function getTierVisual(score) {
            // Returns icon name and background color class for badge
            if (score >= 1700) return { icon: 'trophy', bg: 'bg-amber-500' };
            if (score < 700) return { icon: 'award', bg: 'bg-slate-500' };
            return { icon: 'star', bg: 'bg-emerald-600' };
        }

        function setTopBadge(rank, visual) {
            const img = document.getElementById(`avatar-rank-${rank}`);
            if (!img) return;
            const wrap = img.parentElement; // avatar circle container
            if (!wrap) return;
            wrap.classList.add('relative');
            let badge = wrap.querySelector('.tier-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = `tier-badge absolute -top-1 -left-1 w-6 h-6 rounded-full flex items-center justify-center text-white shadow ring-2 ring-white dark:ring-slate-900`;
                wrap.appendChild(badge);
            }
            badge.className = `tier-badge absolute -top-1 -left-1 w-6 h-6 rounded-full flex items-center justify-center text-white shadow ring-2 ring-white dark:ring-slate-900 ${visual.bg}`;
            badge.innerHTML = `<i data-lucide="${visual.icon}" size="12"></i>`;
        }

        function updateLeaderboardLive() {
            if (!currentUser) return;
            const correct = Math.floor(quizScore / 100);
            const total = quizDB.length;
            const accuracy = Math.round((correct / total) * 100);
            const timeTaken = (typeof QUIZ_START_TIME !== 'undefined' ? QUIZ_START_TIME : 120) - timer;
            const entry = { name: currentUser.name, score: quizScore, seed: currentUser.seed, correct, total, accuracy, time: timeTaken, live: true };
            const idx = leaderboardData.findIndex(e => e.name === currentUser.name && e.live === true);
            if (idx !== -1) {
                leaderboardData[idx] = entry;
            } else {
                leaderboardData.push(entry);
            }
            renderLeaderboard();
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            if(!list) return;
            leaderboardData.sort((a, b) => b.score - a.score);
            const top3 = leaderboardData.slice(0, 3);
            const rest = leaderboardData.slice(3);

            top3.forEach((user, i) => {
                const rank = i + 1;
                document.getElementById(`name-rank-${rank}`).innerText = user.name;
                document.getElementById(`points-rank-${rank}`).innerText = user.score.toLocaleString() + ' نقطة';
                document.getElementById(`avatar-rank-${rank}`).src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.seed}`;
                const tier = getTier(user.score);
                const labelEl = document.getElementById(`label-rank-${rank}`);
                if (labelEl) {
                    const correct = typeof user.correct === 'number' ? user.correct : Math.floor(user.score/100);
                    const total = typeof user.total === 'number' ? user.total : quizDB.length;
                    const accuracy = typeof user.accuracy === 'number' ? user.accuracy : Math.round((correct/total)*100);
                    const liveMark = user.live ? ' • مباشر' : '';
                    labelEl.innerText = `${tier.label}${liveMark} • ${correct}/${total} • ${accuracy}%`;
                    labelEl.className = `text-[10px] md:text-xs font-bold ${tier.color}`;
                }
                // Badge overlay on top 3 avatars
                const visual = getTierVisual(user.score);
                setTopBadge(rank, visual);
            });

            list.innerHTML = rest.map((item, idx) => {
                const tier = getTier(item.score);
                const correct = typeof item.correct === 'number' ? item.correct : Math.floor(item.score/100);
                const total = typeof item.total === 'number' ? item.total : quizDB.length;
                const accuracy = typeof item.accuracy === 'number' ? item.accuracy : Math.round((correct/total)*100);
                const time = typeof item.time === 'number' ? item.time : null;
                const visual = getTierVisual(item.score);
                return `
                <div class="flex items-center justify-between p-4 md:p-6 hover:bg-emerald-500/5 transition-all group">
                    <div class="flex items-center gap-4 md:gap-6">
                        <span class="w-6 font-black text-slate-400 text-xs md:text-sm text-center">${idx + 4}</span>
                        <div class="relative w-10 h-10 md:w-12 md:h-12 rounded-xl bg-slate-100 dark:bg-slate-700/50 overflow-hidden ring-2 ring-transparent group-hover:ring-emerald-500 transition-all">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${item.seed}" class="w-full h-full object-cover">
                            <div class="tier-badge absolute -top-1 -left-1 w-5 h-5 rounded-full flex items-center justify-center text-white ${visual.bg} shadow ring-2 ring-white dark:ring-slate-900">
                                <i data-lucide="${visual.icon}" size="10"></i>
                            </div>
                        </div>
                        <div>
                            <p class="font-black text-sm md:text-base">${item.name} ${item.live ? '<span class="inline-flex items-center gap-1 text-[8px] font-black text-emerald-600 mr-2"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>مباشر</span>' : ''}</p>
                            <p class="text-[9px] font-bold ${tier.color}">${tier.label}</p>
                            <p class="text-[9px] font-bold text-slate-400">الصواب: ${correct}/${total} • الدقة: ${accuracy}%` + (time !== null ? ` • الزمن: ${time}s` : ``) + `</p>
                        </div>
                    </div>
                    <div class="text-left">
                        <p class="font-black text-emerald-500 text-sm md:text-lg">${item.score.toLocaleString()}</p>
                        <p class="text-[8px] font-bold text-slate-400 uppercase">نقطة</p>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- Logic Hooks ---
        function filterBooks(cat, btn) {
            document.querySelectorAll('.lib-filter-btn').forEach(b => b.className = "lib-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all");
            btn.className = "lib-filter-btn shrink-0 px-5 py-2.5 bg-emerald-600 text-white rounded-xl font-black text-xs transition-all shadow-md";
            document.querySelectorAll('.book-card').forEach(card => card.style.display = (cat === 'الكل' || card.getAttribute('data-category') === cat) ? 'block' : 'none');
        }

        function filterLessons(cat, btn) {
            document.querySelectorAll('.les-filter-btn').forEach(b => b.className = "les-filter-btn shrink-0 px-5 py-2.5 rounded-xl font-black text-xs text-slate-500 bg-slate-200 dark:bg-slate-800 hover:bg-emerald-500/10 transition-all");
            btn.className = "les-filter-btn shrink-0 px-5 py-2.5 bg-emerald-600 text-white rounded-xl font-black text-xs transition-all shadow-md";
            document.querySelectorAll('.lesson-card').forEach(card => card.style.display = (cat === 'الكل' || card.getAttribute('data-category') === cat) ? 'block' : 'none');
        }

        // --- Quiz System ---
        const QUIZ_START_TIME = 120;
        let currentQuizIdx = 0, quizScore = 0, timer = QUIZ_START_TIME, quizInterval, statusTimeout;

        // Leaderboard persistence helpers
        function getStoredLeaderboard() {
            try {
                const raw = localStorage.getItem('wr_leaderboard');
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return leaderboardData;
            }
        }
        function saveStoredLeaderboard(data) {
            try { 
                const limited = data.slice(0, 10000);
                localStorage.setItem('wr_leaderboard', JSON.stringify(limited)); 
            } catch (e) {}
        }

        // Load persisted leaderboard on start
        leaderboardData = getStoredLeaderboard();

        function formatTime(secs) {
            const m = Math.floor(secs / 60).toString().padStart(2, '0');
            const s = Math.max(0, secs % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }
        function startQuiz() {
            currentQuizIdx = 0; quizScore = 0; timer = QUIZ_START_TIME;
            document.getElementById('quiz-intro').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            const timerEl = document.getElementById('timer-display');
            if (timerEl && !document.getElementById('answer-status')) {
                const statusEl = document.createElement('div');
                statusEl.id = 'answer-status';
                statusEl.className = 'hidden text-xs md:text-sm font-black px-2 py-1 rounded-md border';
                timerEl.insertAdjacentElement('afterend', statusEl);
            }
            if (timerEl) timerEl.innerText = formatTime(timer);
            // Initialize a live leaderboard entry for the current user
            updateLeaderboardLive();
            loadQuestion();
            quizInterval = setInterval(() => {
                timer--; document.getElementById('timer-display').innerText = formatTime(timer);
                // Update live leaderboard snapshot every second
                updateLeaderboardLive();
                if(timer <= 0) endQuiz();
            }, 1000);
        }
        function loadQuestion() {
            if(currentQuizIdx >= quizDB.length) { endQuiz(); return; }
            const q = quizDB[currentQuizIdx];
            document.getElementById('current-q-num').innerText = currentQuizIdx + 1;
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('score-display').innerText = quizScore;
            const sEl = document.getElementById('answer-status');
            if (sEl) sEl.classList.add('hidden');
            document.getElementById('options-grid').innerHTML = q.a.map((opt, i) => `
                <button onclick="checkAnswer(${i}, this)" class="p-4 md:p-6 bg-white dark:bg-slate-800/50 rounded-2xl font-bold hover:border-emerald-500 border-2 border-transparent transition-all text-right shadow-sm">${opt}</button>
            `).join('');
        }
        function checkAnswer(idx, btn) {
            const isCorrect = idx === quizDB[currentQuizIdx].c;
            const statusEl = document.getElementById('answer-status');
            if (statusTimeout) clearTimeout(statusTimeout);
            if (statusEl) {
                statusEl.textContent = isCorrect ? 'صحيح' : 'خطأ';
                statusEl.className = 'text-xs md:text-sm font-black px-2 py-1 rounded-md border ' + (isCorrect ? 'text-emerald-600 border-emerald-300 bg-emerald-500/10' : 'text-red-600 border-red-300 bg-red-500/10');
                statusEl.classList.remove('hidden');
                statusTimeout = setTimeout(() => statusEl.classList.add('hidden'), 2000);
            }
            // Visual highlight on selected button and disable all options
            try {
                const allBtns = document.querySelectorAll('#options-grid button');
                allBtns.forEach(b => { b.disabled = true; b.classList.add('opacity-70','cursor-not-allowed'); });
                if (btn) {
                    if (isCorrect) {
                        btn.classList.add('border-emerald-500','bg-emerald-50','dark:bg-emerald-900/20','text-emerald-700','dark:text-emerald-400');
                    } else {
                        btn.classList.add('border-red-500','bg-red-50','dark:bg-red-900/20','text-red-700','dark:text-red-400');
                    }
                }
            } catch (e) {}
            if(isCorrect) quizScore += 100;
            // Reflect score change in live leaderboard immediately
            updateLeaderboardLive();
            setTimeout(() => { currentQuizIdx++; loadQuestion(); }, 2000);
        }
        function endQuiz() {
            clearInterval(quizInterval);
            const correct = Math.floor(quizScore / 100);
            const total = quizDB.length;
            const accuracy = Math.round((correct / total) * 100);
            const timeTaken = (typeof QUIZ_START_TIME !== 'undefined' ? QUIZ_START_TIME : 120) - timer;
            if(currentUser) {
                // Remove temporary live snapshot for this user, then add final result
                leaderboardData = leaderboardData.filter(e => !(e.name === currentUser.name && e.live === true));
                leaderboardData.push({ name: currentUser.name, score: quizScore, seed: currentUser.seed, correct, total, accuracy, time: timeTaken });
                // Persist final leaderboard
                saveStoredLeaderboard(leaderboardData);
            }
            renderLeaderboard();
            switchTab('leaderboard');
            document.getElementById('quiz-intro').classList.remove('hidden');
            document.getElementById('quiz-container').classList.add('hidden');
        }

        // --- Navigation & Search ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('lg-nav-active'));
            const dBtn = document.getElementById(`d-nav-${id}`); if(dBtn) dBtn.classList.add('lg-nav-active');
            
            document.querySelectorAll('.m-nav-btn').forEach(b => {
                b.classList.remove('text-emerald-500', 'mobile-nav-active');
                b.classList.add('text-slate-400');
            });
            const mBtn = document.getElementById(`m-nav-${id}`); 
            if(mBtn) { mBtn.classList.add('text-emerald-500', 'mobile-nav-active'); mBtn.classList.remove('text-slate-400'); }

            const titles = {home:'الرئيسية', lessons:'الدروس العلمية', quiz:'تحدي الوقت', library:'المكتبة الرقمية', leaderboard:'لوحة التميز'};
            document.getElementById('page-title').textContent = titles[id];
            
            if(id === 'leaderboard') renderLeaderboard();
            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const icon = document.documentElement.classList.contains('dark') ? 'sun' : 'moon';
            document.getElementById('theme-icon').setAttribute('data-lucide', icon);
            lucide.createIcons();
        }

        function handleSmartSearch(query) {
            const resultsBox = document.getElementById('search-results-box');
            if (!query.trim()) { resultsBox.classList.add('hidden'); return; }
            const results = [], q = query.toLowerCase();

            ['الرئيسية', 'المكتبة', 'الدروس', 'تحدي الوقت', 'التميز'].forEach(item => {
                if (item.includes(q)) results.push({ type: 'قسم', title: item, icon: 'grid', action: () => switchTab(item === 'التميز' ? 'leaderboard' : (item === 'المكتبة' ? 'library' : (item === 'الدروس' ? 'lessons' : (item === 'الرئيسية' ? 'home' : 'quiz')))) });
            });
            libraryDB.forEach(book => { if (book.title.includes(q)) results.push({ type: 'كتاب', title: book.title, icon: 'book', action: () => switchTab('library') }); });
            lessonsDB.forEach(lesson => { if (lesson.title.includes(q)) results.push({ type: 'درس', title: lesson.title, icon: 'video', action: () => switchTab('lessons') }); });

            resultsBox.innerHTML = results.length ? results.slice(0, 8).map(res => `
                <div onclick="(${res.action.toString()})(); document.getElementById('search-results-box').classList.add('hidden')" class="p-4 hover:bg-emerald-500/5 cursor-pointer border-b border-slate-100 dark:border-slate-800/50 flex items-center gap-4 group">
                    <div class="w-9 h-9 rounded-xl bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-emerald-500 group-hover:bg-emerald-500 group-hover:text-white transition-all"><i data-lucide="${res.icon}" size="16"></i></div>
                    <div><p class="text-[9px] font-black text-emerald-600 uppercase mb-1">${res.type}</p><p class="text-sm font-bold">${res.title}</p></div>
                </div>
            `).join('') : '<div class="p-6 text-center text-slate-500 font-bold text-sm">لا توجد نتائج</div>';
            resultsBox.classList.remove('hidden');
            lucide.createIcons();
        }

        function restoreSession() {
            try {
                const raw = localStorage.getItem('wr_session');
                if (!raw) return;
                const sess = JSON.parse(raw);
                if (sess && sess.email) loginUser({ name: sess.name, email: sess.email, seed: sess.seed || sess.name });
            } catch (e) {}
        }

        window.onload = () => {
            lucide.createIcons();
            // Platform remains locked behind auth overlay
            ensureRememberMeUI();
            ensurePasswordToggleUI();
            restoreSession();
        };
    </script>
</body>
</html>
